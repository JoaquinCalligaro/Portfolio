---
import { Image } from 'astro:assets';
import gitSvg from '../../assets/GitHub.svg';
import liveSvg from '../../assets/Live.svg';
import '../../styles/animations.css';
import '../../styles/icon-effects.css';
import img1 from '../../assets/images/BackgroundGenerator/Bg-Generator.webp';
import img2 from '../../assets/images/BackgroundGenerator/Bg-Generator-2.webp';
import img3 from '../../assets/images/BackgroundGenerator/Bg-Generator-3.webp';
import HtmlIcon from '../icons/HtmlIcon.astro';
import CssIcon from '../icons/CssIcon.astro';
import JavascriptIcon from '../icons/JavascriptIcon.astro';
import TailwindIcon from '../icons/TailwindIcon.astro';
import ReactIcon from '../icons/ReactIcon.astro';
import GitIcon from '../icons/GitIcon.astro';
import TypescriptIcon from '../icons/TypescriptIcon.astro';

const props = Astro.props || {};
const title = props.title ?? 'Background Generator';
const technologies = props.technologies ?? [
  'html',
  'css',
  'js',
  'tailwind',
  'react',
  'typescript',
];
const description =
  props.description ??
  'Generador de fondos animados con 8 diseños y más de 25 animaciones personalizables.';
const images = props.images ?? [img1, img2, img3];
const repo = 'https://github.com/JoaquinCalligaro/Background-Generator';
const live = 'https://background-generator-final.netlify.app/';

const sliderId = `slider-${Math.random().toString(36).slice(2, 9)}`;

const iconMap = {
  html: HtmlIcon,
  css: CssIcon,
  js: JavascriptIcon,
  javascript: JavascriptIcon,
  tailwind: TailwindIcon,
  react: ReactIcon,
  git: GitIcon,
  typescript: TypescriptIcon,
};

const finalImages =
  Array.isArray(images) && images.length > 0 ? images : [img1, img2, img3];

const resolveTechnology = (item) => {
  if (!item) return null;
  const base = { cls: 'h-6 w-6', title: '' };
  if (typeof item === 'string') {
    const Component = iconMap[item.toLowerCase()];
    return Component ? { Component, ...base } : null;
  }
  if (typeof item === 'object' && item.component)
    return {
      Component: item.component,
      cls: item.class ?? base.cls,
      title: item.title ?? base.title,
    };
  return null;
};
---

<article
  class="card-root inline-block w-auto transform rounded-2xl border border-white/20 bg-white/60 px-5 py-5 shadow-sm backdrop-blur-md transition-transform duration-1000 ease-in-out hover:scale-110 dark:border-white/10 dark:bg-gray-900/50"
  style="will-change: transform;"
>
  <div class="card-inner">
    <div id={sliderId} class="w-full max-w-full">
      <div
        class="group relative h-64 w-full overflow-hidden rounded-sm bg-transparent sm:h-56 md:h-64 dark:bg-transparent"
      >
        <div
          class="slider-track absolute inset-0 flex transition-transform duration-500 ease-in-out"
          style={`transform: translateX(0%); width: calc(100% * ${finalImages.length});`}
        >
          {
            finalImages.map((src, index) => (
              <div
                class="slide flex h-full items-center justify-center overflow-hidden rounded-sm"
                style={`width: calc(100% / ${finalImages.length}); flex-shrink: 0;`}
              >
                <Image
                  src={src}
                  alt={title + ' - Imagen ' + (index + 1)}
                  class="block max-h-full max-w-full rounded-xl object-contain"
                  sizes="(max-width:640px) 90vw, (max-width:1024px) 720px, 1080px"
                  quality={90}
                  loading={index === 0 ? 'eager' : 'lazy'}
                />
              </div>
            ))
          }
        </div>

        <button
          type="button"
          class="slider-prev absolute top-1/2 left-2 z-30 -translate-y-1/2 rounded-full bg-white/90 p-2 shadow-lg transition-all duration-200 hover:scale-110 hover:bg-white dark:bg-gray-800/90 dark:hover:bg-gray-700"
          aria-label="Imagen anterior"
        >
          <svg
            class="h-4 w-4 text-slate-800 dark:text-white"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            ><path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M15 18l-6-6 6-6"></path></svg
          >
        </button>

        <button
          type="button"
          class="slider-next absolute top-1/2 right-2 z-30 -translate-y-1/2 rounded-full bg-white/90 p-2 shadow-lg transition-all duration-200 hover:scale-110 hover:bg-white dark:bg-gray-800/90 dark:hover:bg-gray-700"
          aria-label="Imagen siguiente"
        >
          <svg
            class="h-4 w-4 text-slate-800 dark:text-white"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            ><path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M9 6l6 6-6 6"></path></svg
          >
        </button>
      </div>

      {
        finalImages.length > 1 && (
          <div class="mt-3 flex items-center justify-center gap-2">
            {finalImages.map((_, i) => (
              <button
                type="button"
                class="slider-dot h-3 w-3 cursor-pointer rounded-full bg-gray-400 transition-all duration-200 hover:bg-gray-600 dark:bg-gray-400 dark:hover:bg-gray-600"
                data-index={i}
                aria-label={'Ir a imagen ' + (i + 1)}
              />
            ))}
          </div>
        )
      }
    </div>

    <div class="mb-4 p-4">
      <div class="mb-4 flex items-center">
        <h3 class="text-lg font-semibold text-gray-900 dark:text-white">
          {title}
        </h3>
      </div>

      {
        technologies && technologies.length > 0 && (
          <div class="my-4 mt-4 flex flex-wrap items-center gap-2">
            {technologies.map((item, idx) => {
              const resolved = resolveTechnology(item);
              if (!resolved) return null;
              const { Component, cls, title: techTitle } = resolved;
              // aplicar la clase de prueba solo al primer icono
              const extra = idx === 0 ? ' border-anim-only' : '';
              return <Component class={`${cls}${extra}`} title={techTitle} />;
            })}
          </div>
        )
      }

      <p class="text-sm leading-relaxed text-slate-600 dark:text-slate-300">
        {description}
      </p>
    </div>

    <div class="flex items-center justify-center gap-4 pt-4 pb-2">
      <a
        href={repo}
        class="inline-flex items-center gap-2 rounded-lg border border-slate-300 bg-white px-4 py-2 text-sm font-medium text-slate-800 transition-all hover:border-slate-800 hover:bg-slate-800 hover:text-white dark:border-gray-600 dark:bg-gray-700 dark:text-slate-100 dark:hover:bg-gray-600"
        target="_blank"
        rel="noopener noreferrer"
      >
        <Image src={gitSvg} alt="GitHub" class="h-4 w-4" loading="lazy" />
        <span>Repositorio</span>
      </a>

      <a
        href={live}
        class="inline-flex items-center gap-2 rounded-lg border border-blue-300 bg-blue-50 px-4 py-2 text-sm font-medium text-blue-800 transition-all hover:border-blue-600 hover:bg-blue-600 hover:text-white dark:border-blue-600 dark:bg-blue-900/30 dark:text-blue-300 dark:hover:bg-blue-600 dark:hover:text-white"
        target="_blank"
        rel="noopener noreferrer"
      >
        <Image
          src={liveSvg}
          alt="Demo en vivo"
          class="h-4 w-4"
          loading="lazy"
        />
        <span>Demo</span>
      </a>
    </div>

    <script type="module" define:vars={{ sliderId }}>
      import initSlider from '/js/slider-client.js';
      initSlider(sliderId);
    </script>
  </div>
</article>
